FROM 172.30.1.1:5000/openshift/openjdk18-openshift AS builder

USER 0

ARG SCRIPT_DIR="/bundler"

COPY "bundler" "$SCRIPT_DIR"

RUN "$SCRIPT_DIR/bin/ljb-setup-start.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-appserver.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-jdbc-driver.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-mail-store.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay-cluster.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay-deployment.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-prometheus.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-finish.sh"



FROM 172.30.1.1:5000/openshift/openjdk18-openshift

USER 0

ARG DEBUG="false"

ARG SCRIPT_DIR="/bundler"

ENV LAUNCH_JBOSS_IN_BACKGROUND="true"
ENV DEBUG="${DEBUG}"

ENV SCRIPT_DIR="${SCRIPT_DIR}"

ENV APPSERVER_TYPE="${APPSERVER_TYPE}"
ENV APPSERVER_VERSION="${APPSERVER_VERSION}"
ENV LIFERAY_PREFIX="${LIFERAY_PREFIX}"
ENV LIFERAY_FULL_VERSION="${LIFERAY_FULL_VERSION}"
ENV LIFERAY_HOME="${LIFERAY_HOME}"
ENV APPSERVER_HOME_PATH="${APPSERVER_HOME_PATH}"

ENV APPSERVER_DOWNLOAD_URL="${APPSERVER_DOWNLOAD_URL}"

ENV LIFERAY_BASE_URL="${LIFERAY_BASE_URL}"

ENV LIFERAY_COPY_CLUSTER_PATH="${LIFERAY_COPY_CLUSTER_PATH}"
ENV LIFERAY_COPY_DEPLOYMENT_PATH="${LIFERAY_COPY_DEPLOYMENT_PATH}"
ENV LIFERAY_PACKAGE_CHECKSUM="${LIFERAY_PACKAGE_CHECKSUM}"
ENV LIFERAY_TURN_OFF_LOGGING="${LIFERAY_TURN_OFF_LOGGING}"

ENV JDBC_DRIVER_DOWNLOAD_URL="${JDBC_DRIVER_DOWNLOAD_URL}"
ENV JDBC_DRIVER_CLASSNAME="${JDBC_DRIVER_CLASSNAME}"
ENV JDBC_DRIVER_CONNECTION_URL="${JDBC_DRIVER_CONNECTION_URL}"
ENV JDBC_DRIVER_USERNAME="${JDBC_DRIVER_USERNAME}"
ENV JDBC_DRIVER_PASSWORD="${JDBC_DRIVER_PASSWORD}"
ENV JDBC_CREDENTIAL_STORE_PASSWORD="${JDBC_CREDENTIAL_STORE_PASSWORD}"

ENV MAIL_CREDENTIAL_STORE_PASSWORD="${MAIL_CREDENTIAL_STORE_PASSWORD}"
ENV MAIL_HOST="${MAIL_HOST}"
ENV MAIL_PORT="${MAIL_PORT}"
ENV MAIL_USERNAME="${MAIL_USERNAME}"
ENV MAIL_PASSWORD="${MAIL_PASSWORD}"
ENV MAIL_ENABLE_SSL="${MAIL_ENABLE_SSL}"
ENV MAIL_ENABLE_TLS="${MAIL_ENABLE_TLS}"

ENV PROMETHEUS_DOWNLOAD_URL="${PROMETHEUS_DOWNLOAD_URL}"
ENV PROMETHEUS_COPY_CONFIG_PATH="${PROMETHEUS_COPY_CONFIG_PATH}"

ENV JKS_FILE_PATH="${JKS_FILE_PATH}"
ENV JKS_STORE_PASSWORD="${JKS_STORE_PASSWORD}"
ENV JKS_KEY_PASSWORD="${JKS_KEY_PASSWORD}"

ENV ELASTIC_TRANSPORT_ADDRESSES="${ELASTIC_TRANSPORT_ADDRESSES}"
ENV ELASTIC_CLUSTER_NAME="${ELASTIC_CLUSTER_NAME}"

COPY --from=builder "$LIFERAY_HOME" "$LIFERAY_HOME"
COPY --from=builder "$APPSERVER_HOME_PATH" "$APPSERVER_HOME_PATH"
COPY --from=builder "$SCRIPT_DIR/bin" "$SCRIPT_DIR/bin"
COPY "prepare.sh" "$SCRIPT_DIR"

EXPOSE 8080
EXPOSE 8443
EXPOSE 11311
EXPOSE 9779
EXPOSE 8787

ENTRYPOINT "$SCRIPT_DIR/prepare.sh" && "$APPSERVER_HOME_PATH/bin/standalone.sh" "-b" "0.0.0.0"

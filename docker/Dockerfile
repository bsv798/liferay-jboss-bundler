FROM openshift/openjdk18-openshift AS builder

ARG SCRIPT_DIR="/bundler"

ARG APPSERVER_TYPE=""
ARG APPSERVER_VERSION=""
ARG LIFERAY_PREFIX=""
ARG LIFERAY_FULL_VERSION=""
ARG LIFERAY_HOME=""
ARG APPSERVER_HOME_PATH=""

ARG APPSERVER_DOWNLOAD_URL=""

ARG LIFERAY_BASE_URL=""

ARG LIFERAY_COPY_CLUSTER_PATH=""
ARG LIFERAY_COPY_DEPLOYMENT_PATH=""
ARG LIFERAY_PACKAGE_CHECKSUM=""
ARG LIFERAY_TURN_OFF_LOGGING=""

ARG JDBC_DRIVER_DOWNLOAD_URL=""
ARG JDBC_DRIVER_CLASSNAME=""
ARG JDBC_DRIVER_CONNECTION_URL=""
ARG JDBC_DRIVER_USERNAME=""
ARG JDBC_DRIVER_PASSWORD=""
ARG JDBC_CREDENTIAL_STORE_PASSWORD=""

ARG MAIL_CREDENTIAL_STORE_PASSWORD=""
ARG MAIL_HOST=""
ARG MAIL_PORT=""
ARG MAIL_USERNAME=""
ARG MAIL_PASSWORD=""
ARG MAIL_ENABLE_SSL=""
ARG MAIL_ENABLE_TLS=""

ARG PROMETHEUS_DOWNLOAD_URL=""
ARG PROMETHEUS_COPY_CONFIG_PATH=""

ARG JKS_FILE_PATH=""
ARG JKS_STORE_PASSWORD=""
ARG JKS_KEY_PASSWORD=""

ARG ELASTIC_TRANSPORT_ADDRESSES=""
ARG ELASTIC_CLUSTER_NAME=""

COPY "bundler" "$SCRIPT_DIR"

RUN "$SCRIPT_DIR/bin/ljb-setup-start.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-appserver.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-jdbc-driver.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-mail-store.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay-cluster.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-liferay-deployment.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-prometheus.sh"
RUN "$SCRIPT_DIR/bin/ljb-setup-finish.sh"



FROM openshift/openjdk18-openshift

ARG DEBUG="false"

ARG SCRIPT_DIR="/bundler"

ARG APPSERVER_TYPE=""
ARG APPSERVER_VERSION=""
ARG LIFERAY_PREFIX=""
ARG LIFERAY_FULL_VERSION=""
ARG LIFERAY_HOME=""
ARG APPSERVER_HOME_PATH=""

ARG APPSERVER_DOWNLOAD_URL=""

ARG LIFERAY_BASE_URL=""

ARG LIFERAY_COPY_CLUSTER_PATH=""
ARG LIFERAY_COPY_DEPLOYMENT_PATH=""
ARG LIFERAY_PACKAGE_CHECKSUM=""
ARG LIFERAY_TURN_OFF_LOGGING=""

ARG JDBC_DRIVER_DOWNLOAD_URL=""
ARG JDBC_DRIVER_CLASSNAME=""
ARG JDBC_DRIVER_CONNECTION_URL=""
ARG JDBC_DRIVER_USERNAME=""
ARG JDBC_DRIVER_PASSWORD=""
ARG JDBC_CREDENTIAL_STORE_PASSWORD=""

ARG MAIL_CREDENTIAL_STORE_PASSWORD=""
ARG MAIL_HOST=""
ARG MAIL_PORT=""
ARG MAIL_USERNAME=""
ARG MAIL_PASSWORD=""
ARG MAIL_ENABLE_SSL=""
ARG MAIL_ENABLE_TLS=""

ARG PROMETHEUS_DOWNLOAD_URL=""
ARG PROMETHEUS_COPY_CONFIG_PATH=""

ARG JKS_FILE_PATH=""
ARG JKS_STORE_PASSWORD=""
ARG JKS_KEY_PASSWORD=""

ARG ELASTIC_TRANSPORT_ADDRESSES=""
ARG ELASTIC_CLUSTER_NAME=""

ENV LAUNCH_JBOSS_IN_BACKGROUND="true"
ENV DEBUG="${DEBUG}"

ENV SCRIPT_DIR="${SCRIPT_DIR}"

ENV APPSERVER_TYPE="${APPSERVER_TYPE}"
ENV APPSERVER_VERSION="${APPSERVER_VERSION}"
ENV LIFERAY_PREFIX="${LIFERAY_PREFIX}"
ENV LIFERAY_FULL_VERSION="${LIFERAY_FULL_VERSION}"
ENV LIFERAY_HOME="${LIFERAY_HOME}"
ENV APPSERVER_HOME_PATH="${APPSERVER_HOME_PATH}"

ENV APPSERVER_DOWNLOAD_URL="${APPSERVER_DOWNLOAD_URL}"

ENV LIFERAY_BASE_URL="${LIFERAY_BASE_URL}"

ENV LIFERAY_COPY_CLUSTER_PATH="${LIFERAY_COPY_CLUSTER_PATH}"
ENV LIFERAY_COPY_DEPLOYMENT_PATH="${LIFERAY_COPY_DEPLOYMENT_PATH}"
ENV LIFERAY_PACKAGE_CHECKSUM="${LIFERAY_PACKAGE_CHECKSUM}"
ENV LIFERAY_TURN_OFF_LOGGING="${LIFERAY_TURN_OFF_LOGGING}"

ENV JDBC_DRIVER_DOWNLOAD_URL="${JDBC_DRIVER_DOWNLOAD_URL}"
ENV JDBC_DRIVER_CLASSNAME="${JDBC_DRIVER_CLASSNAME}"
ENV JDBC_DRIVER_CONNECTION_URL="${JDBC_DRIVER_CONNECTION_URL}"
ENV JDBC_DRIVER_USERNAME="${JDBC_DRIVER_USERNAME}"
ENV JDBC_DRIVER_PASSWORD="${JDBC_DRIVER_PASSWORD}"
ENV JDBC_CREDENTIAL_STORE_PASSWORD="${JDBC_CREDENTIAL_STORE_PASSWORD}"

ENV MAIL_CREDENTIAL_STORE_PASSWORD="${MAIL_CREDENTIAL_STORE_PASSWORD}"
ENV MAIL_HOST="${MAIL_HOST}"
ENV MAIL_PORT="${MAIL_PORT}"
ENV MAIL_USERNAME="${MAIL_USERNAME}"
ENV MAIL_PASSWORD="${MAIL_PASSWORD}"
ENV MAIL_ENABLE_SSL="${MAIL_ENABLE_SSL}"
ENV MAIL_ENABLE_TLS="${MAIL_ENABLE_TLS}"

ENV PROMETHEUS_DOWNLOAD_URL="${PROMETHEUS_DOWNLOAD_URL}"
ENV PROMETHEUS_COPY_CONFIG_PATH="${PROMETHEUS_COPY_CONFIG_PATH}"

ENV JKS_FILE_PATH="${JKS_FILE_PATH}"
ENV JKS_STORE_PASSWORD="${JKS_STORE_PASSWORD}"
ENV JKS_KEY_PASSWORD="${JKS_KEY_PASSWORD}"

ENV ELASTIC_TRANSPORT_ADDRESSES="${ELASTIC_TRANSPORT_ADDRESSES}"
ENV ELASTIC_CLUSTER_NAME="${ELASTIC_CLUSTER_NAME}"

RUN apk add --no-cache curl

RUN addgroup -S liferay
RUN adduser -S -H liferay liferay

USER liferay:liferay

COPY --from=builder --chown=liferay:liferay "$LIFERAY_HOME" "$LIFERAY_HOME"
COPY --from=builder --chown=liferay:liferay "$APPSERVER_HOME_PATH" "$APPSERVER_HOME_PATH"
COPY --from=builder --chown=liferay:liferay "$SCRIPT_DIR/bin" "$SCRIPT_DIR/bin"
COPY --chown=liferay:liferay "prepare.sh" "$SCRIPT_DIR"

EXPOSE 8080
EXPOSE 8443
EXPOSE 11311
EXPOSE 9779
EXPOSE 8787

HEALTHCHECK --start-period=5m --interval=5m --timeout=10s --retries=6 \
        CMD curl -f -s -k -o /dev/null https://localhost:8443/ || exit 1

ENTRYPOINT "$SCRIPT_DIR/prepare.sh" && "$APPSERVER_HOME_PATH/bin/standalone.sh" "-b" "0.0.0.0"
